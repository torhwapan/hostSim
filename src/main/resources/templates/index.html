<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Host Simulator</title>
    <!-- 使用替代CDN源加载jQuery和bootstrap -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            font-size: 12px;
        }
        .container-fluid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto 1fr;
            grid-template-areas: 
                "simulators messages"
                "properties message-detail"
                "message-properties send-area";
            gap: 15px;
            height: calc(100vh - 20px);
        }
        .section {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .simulators-section {
            grid-area: simulators;
        }
        .messages-section {
            grid-area: messages;
        }
        .properties-section {
            grid-area: properties;
        }
        .message-detail-section {
            grid-area: message-detail;
        }
        .message-properties-section {
            grid-area: message-properties;
            min-height: 350px;
        }
        .send-area-section {
            grid-area: send-area;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
        }
        /* 为所有表格容器添加滚动样式 */
        .table-responsive {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: auto;
            max-height: 250px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* 确保表头在滚动时保持可见 */
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #ddd;
            font-size: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
            font-size: 12px;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background-color: #f5f5f5;
            cursor: pointer;
        }
        tr.selected {
            background-color: #e3f2fd;
        }
        .detail-box {
            flex-grow: 1;
            border: 1px solid #ddd;
            padding: 10px;
            overflow: auto;
            white-space: pre-wrap;
            background-color: #f9f9f9;
            font-size: 12px;
        }
        .form-group {
            margin-bottom: 10px;
        }
        .btn {
            margin-right: 5px;
            font-size: 12px;
        }
        .connection-set {
            display: none;
            margin-top: 10px;
        }
        .connection-set-row {
            display: flex;
            margin-bottom: 5px;
        }
        .connection-set-label {
            width: 100px;
            font-weight: bold;
            font-size: 12px;
        }
        .connection-set-value {
            flex-grow: 1;
            font-size: 12px;
        }
        .file-upload-btn {
            margin-top: 5px;
        }
        .button-container {
            margin-top: auto;
            padding-top: 10px;
        }
        .save-btn {
            margin-top: auto;
        }
        .send-btn {
            margin-top: auto;
        }
        .send-textarea {
            width: 100%;
            flex-grow: 1;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- 左上角：Simulators表格 -->
        <div class="section simulators-section">
            <div class="section-title">Simulators</div>
            <div class="table-responsive">
                <table id="simulators-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Connection</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="simulator : ${simulators}" th:data-name="${simulator.name}">
                            <td th:text="${simulator.name}"></td>
                            <td th:text="${simulator.connection}"></td>
                            <td th:text="${simulator.description}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 右上角：Messages表格 -->
        <div class="section messages-section">
            <div class="section-title">Messages <button id="refresh-messages-btn" class="btn btn-primary btn-sm" style="float: right; margin-top: -5px;">Refresh</button></div>
            <div class="table-responsive">
                <table id="messages-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>TID</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="message : ${messages}" th:data-tid="${message.tid}">
                            <td th:text="${message.time}"></td>
                            <td th:text="${message.tid}"></td>
                            <td th:text="${message.message}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 左中间：Properties表格 -->
        <div class="section properties-section">
            <div class="section-title">Properties</div>
            <div id="property-content">
                <div class="property-row">
                    <div class="connection-set-row">
                        <div class="connection-set-label">Name:</div>
                        <div class="connection-set-value" id="property-name" th:text="${selectedProperty?.name}"></div>
                    </div>
                </div>
                <div class="property-row">
                    <div class="connection-set-row">
                        <div class="connection-set-label">SystemID:</div>
                        <div class="connection-set-value" id="property-systemId" th:text="${selectedProperty?.systemId}"></div>
                    </div>
                </div>
                <div class="property-row">
                    <div class="connection-set-row">
                        <div class="connection-set-label">Connection Type:</div>
                        <div class="connection-set-value" id="property-connectionType" th:text="${selectedProperty?.connectionType}"></div>
                    </div>
                </div>
                <div class="property-row">
                    <div class="connection-set-row">
                        <div class="connection-set-label">文件状态:</div>
                        <div class="connection-set-value">
                            <div id="upload-status" style="display: inline-block;">未上传文件</div>
                            <input type="file" id="file-upload" class="file-upload-btn form-control" accept=".xml" style="margin-top: 5px;">
                        </div>
                    </div>
                </div>
                <div class="property-row">
                    <div class="connection-set-row" id="connection-set-header">
                        <div class="connection-set-label">Connection Set</div>
                        <div class="connection-set-value">
                            <button id="toggle-connection-set" class="btn btn-sm btn-primary">Show</button>
                        </div>
                    </div>
                    <div class="connection-set" id="connection-set-content">
                        <div class="connection-set-row">
                            <div class="connection-set-label">IP:</div>
                            <div class="connection-set-value" id="connection-ip" th:text="${selectedProperty?.connectionSet?.ip}"></div>
                        </div>
                        <div class="connection-set-row">
                            <div class="connection-set-label">Port:</div>
                            <div class="connection-set-value" id="connection-port" th:text="${selectedProperty?.connectionSet?.port}"></div>
                        </div>
                        <div class="connection-set-row">
                            <div class="connection-set-label">Listen Queue:</div>
                            <div class="connection-set-value" id="connection-listenQueue" th:text="${selectedProperty?.connectionSet?.listenQueue}"></div>
                        </div>
                        <div class="connection-set-row">
                            <div class="connection-set-label">Target Queue:</div>
                            <div class="connection-set-value" id="connection-targetQueue" th:text="${selectedProperty?.connectionSet?.targetQueue}"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右中间：Message Detail文本框 -->
        <div class="section message-detail-section">
            <div class="section-title">Message Detail</div>
            <div class="detail-box" id="message-detail">
                Select a message to view details
            </div>
        </div>

        <!-- 左下角：Message properties表格 -->
        <div class="section message-properties-section">
            <div class="section-title">Message properties</div>
            <div class="table-responsive">
                <table id="message-properties-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>IsDefault</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="property : ${messageProperties}" th:data-id="${property.name}">
                            <td th:text="${property.name}"></td>
                            <td th:text="${property.description}"></td>
                            <td>
                                <input type="checkbox" class="is-default-checkbox" th:checked="${property.default}">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="button-container">
                <button id="save-properties-btn" class="btn btn-primary">Save</button>
            </div>
        </div>

        <!-- 右下：Send按钮和文本框 -->
        <div class="section send-area-section">
            <div class="section-title">Send Message</div>
            <textarea id="send-textarea" class="send-textarea form-control" placeholder="Click on a simulator row to display details here..."></textarea>
            <div class="button-container">
                <button id="send-btn" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // 当前选中的模拟器名称
            var selectedSimulator = '';
            var simulatorUploads = {}; // 存储每个模拟器的文件上传状态
            
            // 1. Simulators表格行点击事件
            $('#simulators-table tbody tr').click(function() {
                // 移除所有选中状态
                $('#simulators-table tbody tr').removeClass('selected');
                // 添加当前行选中状态
                $(this).addClass('selected');
                
                // 获取选中的模拟器名称
                selectedSimulator = $(this).data('name');
                console.log('Simulator selected:', selectedSimulator);
                
                // 更新Properties表格
                console.log('Calling updateProperties with simulator:', selectedSimulator);
                updateProperties(selectedSimulator);
                // 更新Message properties表格（加载对应模拟器的数据）
                console.log('Calling loadSimulatorMessageProperties with simulator:', selectedSimulator);
                loadSimulatorMessageProperties(selectedSimulator);
                console.log('Both update functions called for simulator:', selectedSimulator);
                
                // 重置文件上传组件状态
                $('.file-upload').val('');
            });
            
            // 2. Messages表格行点击事件
            $('#messages-table tbody tr').click(function() {
                // 移除所有选中状态
                $('#messages-table tbody tr').removeClass('selected');
                // 添加当前行选中状态
                $(this).addClass('selected');
                
                // 获取选中的消息TID
                var tid = $(this).data('tid');
                
                // 更新Message Detail
                updateMessageDetail(tid);
            });
            
            // 3. 切换Connection Set显示/隐藏
            $('#toggle-connection-set').click(function() {
                var content = $('#connection-set-content');
                var btn = $(this);
                
                if (content.is(':visible')) {
                    content.hide();
                    btn.text('Show');
                } else {
                    content.show();
                    btn.text('Hide');
                }
            });
            
            // 4. 文件上传功能
            $('#file-upload').change(function() {
                var file = this.files[0];
                if (file) {
                    uploadFile(file, selectedSimulator);
                }
            });
            
            // 5. 保存消息属性配置
            $('#save-properties-btn').click(function() {
                saveMessageProperties();
            });
            
            // 6. 发送消息
            $('#send-btn').click(function() {
                sendMessage();
            });
            
            // 更新Properties表格
            function updateProperties(simulatorName) {
                $.ajax({
                    url: '/xmlparser/api/property/' + simulatorName,
                    type: 'GET',
                    success: function(property) {
                        // 更新Properties内容
                        $('#property-name').text(property.name);
                        $('#property-systemId').text(property.systemId);
                        $('#property-connectionType').text(property.connectionType);
                        // 不再使用mqLibrary字段
                        $('#connection-ip').text(property.connectionSet.ip);
                        $('#connection-port').text(property.connectionSet.port);
                        $('#connection-listenQueue').text(property.connectionSet.listenQueue);
                        $('#connection-targetQueue').text(property.connectionSet.targetQueue);
                         
                        // 更新文件上传状态显示
                        updateUploadStatus(simulatorName);
                         
                        // 不再从simulator属性更新Send文本框，而是从Message properties表格更新
                    },
                    error: function() {
                        alert('Failed to load property data');
                    }
                });
            }
            
            // 更新文件上传状态显示
            function updateUploadStatus(simulatorName) {
                if (simulatorUploads[simulatorName]) {
                    $('#upload-status').text('已上传文件：' + simulatorUploads[simulatorName]);
                    $('#upload-status').css('color', '#28a745'); // 成功颜色
                } else {
                    $('#upload-status').text('未上传文件');
                    $('#upload-status').css('color', '#6c757d'); // 默认颜色
                }
            }
            
            // 更新Message Detail
            function updateMessageDetail(tid) {
                $.ajax({
                    url: '/xmlparser/api/message/detail/' + tid,
                    type: 'GET',
                    success: function(message) {
                        $('#message-detail').text(message.detail);
                    },
                    error: function() {
                        alert('Failed to load message detail');
                    }
                });
            }
            
            // 更新Send文本框
            function updateSendTextarea(property) {
                // 构建要显示的内容
                var content = 'Selected Message Property:\n';
                content += 'Name: ' + property.name + '\n';
                content += 'Description: ' + property.description + '\n';
                content += 'Default: ' + (property.default ? 'Yes' : 'No');
                
                $('#send-textarea').val(content);
            }
            
            // 上传文件
            function uploadFile(file, simulatorName) {
                if (!simulatorName) {
                    alert('Please select a simulator first');
                    return;
                }
                
                var formData = new FormData();
                formData.append('file', file);
                formData.append('simulatorName', simulatorName);
                
                $.ajax({
                    url: '/xmlparser/api/upload',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(properties) {
                        // 更新文件上传状态
                        simulatorUploads[simulatorName] = file.name;
                        $('#upload-status').text('已上传文件：' + file.name);
                        $('#upload-status').css('color', '#28a745'); // 成功颜色
                        
                        // 显示成功消息
                        alert('文件上传成功：' + file.name);
                        
                        // 更新Message properties表格
                        updateMessagePropertiesTable(properties);
                    },
                    error: function() {
                        // 清除文件上传状态
                        simulatorUploads[simulatorName] = null;
                        $('#upload-status').text('未上传文件');
                        $('#upload-status').css('color', '#6c757d'); // 默认颜色
                        alert('Failed to upload file');
                    }
                });
            }
            
            // 加载选中模拟器的消息属性
            function loadSimulatorMessageProperties(simulatorName) {
                console.log('Loading message properties for simulator: ' + simulatorName);
                $.ajax({
                    url: '/xmlparser/api/message-properties/' + simulatorName,
                    type: 'GET',
                    success: function(properties) {
                        console.log('Successfully loaded message properties:', properties);
                        updateMessagePropertiesTable(properties);
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load message properties for simulator: ' + simulatorName, error);
                        console.log('Response status:', status);
                        console.log('Response text:', xhr.responseText);
                        // 清除表格内容以确保显示为空
                        $('#message-properties-table tbody').empty();
                    }
                });
            }
            
            // 更新Message properties表格
            function updateMessagePropertiesTable(properties) {
                var tbody = $('#message-properties-table tbody');
                tbody.empty();
                
                properties.forEach(function(property) {
                    var row = $('<tr data-id="' + property.name + '"></tr>');
                    row.append('<td>' + property.name + '</td>');
                    row.append('<td>' + property.description + '</td>');
                    row.append('<td><input type="checkbox" class="is-default-checkbox" ' + 
                               (property.default ? 'checked' : '') + '></td>');
                    tbody.append(row);
                });
                
                // 重新绑定点击事件
                $('.is-default-checkbox').change(function() {
                    // 确保只有一个默认属性
                    if (this.checked) {
                        $('.is-default-checkbox').not(this).prop('checked', false);
                    }
                });
                
                // 为Message properties表格行添加点击事件
                $('#message-properties-table tbody tr').click(function() {
                    $('#message-properties-table tbody tr').removeClass('selected');
                    $(this).addClass('selected');
                    var name = $(this).data('id');
                    var description = $(this).find('td:nth-child(2)').text();
                    var isDefault = $(this).find('.is-default-checkbox').prop('checked');
                    
                    // 构建property对象
                    var property = {
                        name: name,
                        description: description,
                        default: isDefault
                    };
                    
                    // 更新Send文本框
                    updateSendTextarea(property);
                });
            }
            
            // 保存消息属性配置
            function saveMessageProperties() {
                if (!selectedSimulator) {
                    alert('Please select a simulator first');
                    return;
                }
                
                var properties = [];
                
                $('#message-properties-table tbody tr').each(function() {
                    var name = $(this).data('id');
                    var description = $(this).find('td:nth-child(2)').text();
                    var isDefault = $(this).find('.is-default-checkbox').prop('checked');
                    
                    properties.push({
                        name: name,
                        description: description,
                        default: isDefault
                    });
                });
                
                $.ajax({
                    url: '/xmlparser/api/save/properties',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        properties: properties,
                        simulatorName: selectedSimulator
                    }),
                    success: function() {
                        alert('Properties saved successfully');
                        // 刷新消息列表
                        refreshMessages();
                    },
                    error: function() {
                        alert('Failed to save properties');
                    }
                });
            }
            
            // 发送消息
            function sendMessage() {
                var content = $('#send-textarea').val();
                
                if (content.trim() === '') {
                    alert('Please enter a message to send');
                    return;
                }
                
                if (!selectedSimulator) {
                    alert('Please select a simulator first');
                    return;
                }
                
                $.ajax({
                    url: '/xmlparser/api/send/message',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({content: content, simulatorName: selectedSimulator}),
                    success: function() {
                        alert('Message sent successfully');
                        // 刷新消息列表
                        refreshMessages();
                    },
                    error: function() {
                        alert('Failed to send message');
                    }
                });
            }
            
            // 刷新消息列表
            function refreshMessages() {
                $.ajax({
                    url: '/xmlparser/api/messages',
                    type: 'GET',
                    success: function(messages) {
                        var tbody = $('#messages-table tbody');
                        tbody.empty();
                        
                        messages.forEach(function(message) {
                            var row = $('<tr data-tid="' + message.tid + '"></tr>');
                            row.append('<td>' + message.time + '</td>');
                            row.append('<td>' + message.tid + '</td>');
                            row.append('<td>' + message.message + '</td>');
                            tbody.append(row);
                        });
                        
                        // 重新绑定点击事件
                        $('#messages-table tbody tr').click(function() {
                            $('#messages-table tbody tr').removeClass('selected');
                            $(this).addClass('selected');
                            var tid = $(this).data('tid');
                            updateMessageDetail(tid);
                        });
                    }
                });
            }
            
            // 默认选中第一个模拟器
            if ($('#simulators-table tbody tr').length > 0) {
                selectedSimulator = $('#simulators-table tbody tr:first').data('name');
                $('#simulators-table tbody tr:first').click();
            }
            
            // 默认选中第一个消息
            if ($('#messages-table tbody tr').length > 0) {
                $('#messages-table tbody tr:first').click();
            }
            
            // 为刷新消息按钮添加点击事件
            $('#refresh-messages-btn').click(function() {
                refreshMessages();
            });
            
            // 为初始渲染的Message properties表格行添加点击事件
            $('#message-properties-table tbody tr').click(function() {
                $('#message-properties-table tbody tr').removeClass('selected');
                $(this).addClass('selected');
                var name = $(this).data('id');
                var description = $(this).find('td:nth-child(2)').text();
                var isDefault = $(this).find('.is-default-checkbox').prop('checked');
                
                // 构建property对象
                var property = {
                    name: name,
                    description: description,
                    default: isDefault
                };
                
                // 更新Send文本框
                updateSendTextarea(property);
            });
        });
    </script>
</body>
</html>